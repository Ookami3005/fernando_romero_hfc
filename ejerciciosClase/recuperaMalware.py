#!/usr/bin/python
# Hacking Fight Club
import argparse

parser = argparse.ArgumentParser(prog='RecuperarMalware', description='Recupera un malware de un archivo en cuarentena')

parser.add_argument('filename', help='Nombre del archivo en cuarentena')
parser.add_argument('-o', '--output', default='malware', help='Nombre del archivo de salida con el malware recuperado')
args = parser.parse_args()

archivo = args.filename
contenido = None
contenidoFinal = None

try:
    lector = open(archivo, 'rb')
    contenido = lector.read()
except Exception:
    print("Error al abrir el archivo")
finally:
    lector.close()

for i in range(256):
    xor_data = bytes(byte ^ i for byte in contenido)
    if 'MZ'.encode() in xor_data and 'DOS'.encode() in xor_data:
        contenidoFinal = xor_data

pos = contenidoFinal.index(b'MZ')

try:
    escritor = open(args.output,'wb')
    escritor.write(contenidoFinal[pos:])
except Exception:
    print('Hubo un error al escribir el archivo')
finally:
    escritor.close()
